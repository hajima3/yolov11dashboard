<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YOLOv11 Drowning Detection Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(180deg, #001144 0%, #003366 50%, #002244 100%);
            color: #fff;
            min-height: 100vh;
        }
        #koiCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }
        header {
            text-align: center;
            padding: 30px 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5); }
        .subtitle { font-size: 1.2em; opacity: 0.9; color: #88ccff; }
        
        /* Tabs */
        .tab-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 15px;
        }
        .tab-button {
            flex: 1;
            padding: 15px 30px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            cursor: pointer;
            border-radius: 10px;
            font-size: 1.1em;
            transition: all 0.3s ease;
        }
        .tab-button:hover { background: rgba(255, 255, 255, 0.2); }
        .tab-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            margin-bottom: 30px;
        }
        .video-section, .controls-section, .card, .logs-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .controls-section { display: flex; flex-direction: column; gap: 20px; }
        .card-title {
            font-size: 1.5em;
            margin-bottom: 15px;
            color: #88ccff;
            border-bottom: 2px solid rgba(136, 204, 255, 0.3);
            padding-bottom: 10px;
        }
        #videoFeed { width: 100%; border-radius: 10px; background: #000; min-height: 480px; display: block; }
        .video-placeholder {
            width: 100%;
            height: 480px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 20px;
        }
        .video-placeholder svg { width: 100px; height: 100px; opacity: 0.5; }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 10px;
            font-weight: bold;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4); }
        button.danger { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        button.success { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        
        .slider-container { margin: 20px 0; }
        .slider-container label { display: block; margin-bottom: 10px; font-size: 1.1em; }
        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            -webkit-appearance: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #88ccff;
            cursor: pointer;
        }
        .confidence-value { text-align: center; font-size: 1.5em; font-weight: bold; color: #88ccff; margin-top: 10px; }
        
        input[type="file"] { display: none; }
        .file-upload-label {
            display: block;
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
            padding: 15px 30px;
            font-size: 1.1em;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        .file-upload-label:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(250, 112, 154, 0.4); }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        .status-indicator.active { background: #00ff00; }
        .status-indicator.inactive { background: #ff0000; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 1.1em;
            font-weight: bold;
        }
        .alert.success { 
            background: rgba(40, 167, 69, 0.2); 
            border: 1px solid rgba(40, 167, 69, 0.5); 
        }
        .alert.warning { 
            background: rgba(255, 165, 0, 0.8); 
            border: 2px solid rgba(255, 165, 0, 1); 
            color: white;
            font-size: 1.2em;
            box-shadow: 0 0 15px rgba(255, 165, 0, 0.6);
        }
        .alert.error { 
            background: rgba(220, 53, 69, 0.9); 
            border: 2px solid rgba(220, 53, 69, 1); 
            color: white;
            font-size: 1.3em;
            animation: alertPulse 0.5s ease-in-out infinite alternate;
            box-shadow: 0 0 20px rgba(220, 53, 69, 0.8);
        }
        @keyframes alertPulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.02); }
        }
        
        /* Logs */
        .logs-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-card.danger { background: rgba(220, 53, 69, 0.3); border: 2px solid rgba(220, 53, 69, 0.5); }
        .stat-card.warning { background: rgba(255, 165, 0, 0.3); border: 2px solid rgba(255, 165, 0, 0.5); }
        .stat-card.success { background: rgba(40, 167, 69, 0.3); border: 2px solid rgba(40, 167, 69, 0.5); }
        .stat-number { font-size: 2.5em; font-weight: bold; color: #88ccff; }
        .stat-card.danger .stat-number { color: #ff6b6b; }
        .stat-card.warning .stat-number { color: #ffa500; }
        .stat-card.success .stat-number { color: #51cf66; }
        .stat-text { font-size: 1em; opacity: 0.9; margin-top: 5px; }
        
        .log-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .log-table th {
            background: rgba(102, 126, 234, 0.3);
            padding: 15px;
            text-align: left;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }
        .log-table td { padding: 12px 15px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .log-table tr:hover { background: rgba(255, 255, 255, 0.05); }
        .log-row.level2-row { background: rgba(220, 53, 69, 0.15); border-left: 4px solid #ff6b6b; }
        .log-row.level1-row { background: rgba(255, 165, 0, 0.1); border-left: 4px solid #ffa500; }
        
        .log-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            white-space: nowrap;
        }
        .log-badge.level2 { background: #ff6b6b; color: white; }
        .log-badge.level1 { background: #ffa500; color: white; }
        
        .log-actions { display: flex; gap: 10px; }
        .log-actions button { padding: 5px 15px; font-size: 0.9em; margin: 0; width: auto; }
        
        .edit-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            width: 100%;
        }
        
        .filter-section { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-button {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.3s ease;
            width: auto;
            margin: 0;
        }
        .filter-button.active-filter {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
        }
        .export-button { background: linear-gradient(135deg, #38ef7d 0%, #11998e 100%); padding: 10px 20px; width: auto; margin: 0; }
        .logs-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        @media (max-width: 1200px) { .main-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <canvas id="koiCanvas"></canvas>
    <div class="container">
        <header>
            <h1>🏊 YOLOv11 Drowning Detection Dashboard</h1>
            <p class="subtitle">Real-time Detection with AI-Powered Safety Monitoring & Incident Logging</p>
        </header>

        <div id="alertBox"></div>

        <div class="tab-nav">
            <button class="tab-button active" onclick="switchTab('detection')">📹 Live Detection</button>
            <button class="tab-button" onclick="switchTab('logs')">📋 Incident Logs</button>
        </div>

        <!-- Detection Tab -->
        <div id="detectionTab" class="tab-content active">
            <div class="main-grid">
                <div class="video-section">
                    <div class="card-title">
                        <span class="status-indicator inactive" id="statusIndicator"></span>
                        Live Detection Feed
                    </div>
                    <div id="videoContainer">
                        <div class="video-placeholder">
                            <svg fill="currentColor" viewBox="0 0 20 20">
                                <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"></path>
                            </svg>
                            <p>No video source active</p>
                            <p style="opacity: 0.7; font-size: 0.9em;">Start webcam or upload a video</p>
                        </div>
                    </div>
                </div>

                <div class="controls-section">
                    <div class="card">
                        <h3 class="card-title">📹 Camera Control</h3>
                        <button onclick="startWebcam()" class="success">🎥 Start Webcam Detection</button>
                        <button onclick="stopDetection()" class="danger">⏹️ Stop Detection</button>
                    </div>

                    <div class="card">
                        <h3 class="card-title">📤 Upload Video</h3>
                        <label for="videoUpload" class="file-upload-label">📁 Choose Video File</label>
                        <input type="file" id="videoUpload" accept="video/*" onchange="uploadVideo(this)">
                        <p style="opacity: 0.7; font-size: 0.9em; margin-top: 10px; text-align: center;">Supports MP4, AVI, MOV</p>
                    </div>

                    <div class="card">
                        <h3 class="card-title">⚙️ Detection Settings</h3>
                        <div class="slider-container">
                            <label>Confidence Threshold:</label>
                            <input type="range" id="confidenceSlider" min="10" max="90" value="50" oninput="updateConfidence(this.value)">
                            <div class="confidence-value" id="confidenceValue">50%</div>
                        </div>
                        <p style="opacity: 0.7; font-size: 0.9em; margin-top: 15px;">
                            Lower = More detections<br>Higher = More accurate
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logs Tab -->
        <div id="logsTab" class="tab-content">
            <div class="logs-container">
                <div class="logs-header">
                    <h2 class="card-title" style="margin: 0;">📋 Drowning Incident Logs</h2>
                    <button class="export-button" onclick="exportLogs()">💾 Export to CSV</button>
                </div>

                <div class="logs-stats">
                    <div class="stat-card danger">
                        <div class="stat-number" id="level2Count">0</div>
                        <div class="stat-text">🚨 Level 2 Emergencies</div>
                        <div style="font-size: 0.8em; opacity: 0.8; margin-top: 5px;">Drowning (75%+ confidence)</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-number" id="level1Count">0</div>
                        <div class="stat-text">⚠️ Level 1 Warnings</div>
                        <div style="font-size: 0.8em; opacity: 0.8; margin-top: 5px;">Unsafe Movement (50-75%)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="todayIncidentsCount">0</div>
                        <div class="stat-text">📅 Today's Incidents</div>
                        <div style="font-size: 0.8em; opacity: 0.8; margin-top: 5px;">All alerts today</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalLogsCount">0</div>
                        <div class="stat-text">📊 Total Alerts</div>
                        <div style="font-size: 0.8em; opacity: 0.8; margin-top: 5px;">All time records</div>
                    </div>
                </div>

                <div class="filter-section">
                    <button class="filter-button active-filter" onclick="filterLogs('all', event)">📊 All Alerts</button>
                    <button class="filter-button" onclick="filterLogs('level2', event)">🚨 Level 2 Only</button>
                    <button class="filter-button" onclick="filterLogs('level1', event)">⚠️ Level 1 Only</button>
                    <button class="filter-button" onclick="filterLogs('today', event)">📅 Today</button>
                    <button class="filter-button danger" onclick="clearAllLogs()">🗑️ Clear All Logs</button>
                </div>

                <div style="overflow-x: auto;">
                    <table class="log-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Timestamp</th>
                                <th>Alert Level</th>
                                <th>Confidence</th>
                                <th>Notes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="logsTableBody">
                            <tr><td colspan="6" style="text-align: center; padding: 40px; opacity: 0.6;">No incidents logged yet.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // Koi animation
        const canvas = document.getElementById('koiCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        class Koi {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.vx = (Math.random() - 0.5) * 2;
                this.vy = (Math.random() - 0.5) * 2;
                this.size = Math.random() * 30 + 20;
                this.hue = Math.random() * 60 + 10;
            }
            update() {
                this.x += this.vx;
                this.y += this.vy;
                if (this.x < 0 || this.x > canvas.width) this.vx *= -1;
                if (this.y < 0 || this.y > canvas.height) this.vy *= -1;
            }
            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(Math.atan2(this.vy, this.vx));
                ctx.fillStyle = `hsla(${this.hue}, 80%, 60%, 0.6)`;
                ctx.beginPath();
                ctx.ellipse(0, 0, this.size, this.size * 0.5, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.moveTo(-this.size, 0);
                ctx.lineTo(-this.size * 1.5, -this.size * 0.5);
                ctx.lineTo(-this.size * 1.5, this.size * 0.5);
                ctx.closePath();
                ctx.fill();
                ctx.restore();
            }
        }

        const kois = Array(8).fill().map(() => new Koi());
        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            kois.forEach(koi => { koi.update(); koi.draw(); });
            requestAnimationFrame(animate);
        }
        animate();
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });

        // Tab switching
        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            if (tab === 'detection') {
                document.getElementById('detectionTab').classList.add('active');
                document.querySelector('[onclick="switchTab(\'detection\')"]').classList.add('active');
            } else {
                document.getElementById('logsTab').classList.add('active');
                document.querySelector('[onclick="switchTab(\'logs\')"]').classList.add('active');
                refreshLogs();
            }
        }

        // Logging system
        let incidentLogs = JSON.parse(localStorage.getItem('drowningLogs')) || [];
        let logIdCounter = parseInt(localStorage.getItem('logIdCounter')) || 1;
        let currentFilter = 'all';

        function addLog(type, confidence) {
            const log = {
                id: logIdCounter++,
                timestamp: new Date().toISOString(),
                type: type,
                confidence: confidence,
                notes: ''
            };
            incidentLogs.unshift(log);
            localStorage.setItem('drowningLogs', JSON.stringify(incidentLogs));
            localStorage.setItem('logIdCounter', logIdCounter.toString());
            updateLogsDisplay();
            
            // Alert based on level
            if (type.includes('Level 2')) {
                showAlert('🚨 LEVEL 2 EMERGENCY DETECTED! Drowning incident logged. Contact medical authorities immediately!', 'error');
            } else if (type.includes('Level 1')) {
                showAlert('⚠️ LEVEL 1 WARNING DETECTED! Unsafe movement detected. Staff intervention recommended.', 'warning');
            }
        }

        function updateLogsDisplay() {
            const tbody = document.getElementById('logsTableBody');
            let filteredLogs = incidentLogs;

            if (currentFilter === 'level2') {
                filteredLogs = incidentLogs.filter(log => log.type.includes('Level 2'));
            } else if (currentFilter === 'level1') {
                filteredLogs = incidentLogs.filter(log => log.type.includes('Level 1'));
            } else if (currentFilter === 'today') {
                const today = new Date().toDateString();
                filteredLogs = incidentLogs.filter(log => new Date(log.timestamp).toDateString() === today);
            }

            if (filteredLogs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; opacity: 0.6;">No incidents match filter.</td></tr>';
            } else {
                tbody.innerHTML = filteredLogs.map(log => {
                    const date = new Date(log.timestamp);
                    const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                    const isLevel2 = log.type.includes('Level 2');
                    const badgeClass = isLevel2 ? 'level2' : 'level1';
                    return `
                        <tr class="${isLevel2 ? 'log-row level2-row' : 'log-row level1-row'}">
                            <td>#${log.id}</td>
                            <td>${formattedDate}</td>
                            <td><span class="log-badge ${badgeClass}">${log.type}</span></td>
                            <td>${log.confidence}%</td>
                            <td>
                                <span id="note-${log.id}">${log.notes || 'No notes'}</span>
                                <input type="text" id="edit-${log.id}" class="edit-input" style="display:none;" value="${log.notes}">
                            </td>
                            <td class="log-actions">
                                <button onclick="editLog(${log.id})" id="editBtn-${log.id}">✏️ Edit</button>
                                <button onclick="saveLog(${log.id})" id="saveBtn-${log.id}" style="display:none;" class="success">💾 Save</button>
                                <button onclick="deleteLog(${log.id})" class="danger">🗑️ Delete</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
            updateLogStats();
        }

        function updateLogStats() {
            const level2Count = incidentLogs.filter(log => log.type.includes('Level 2')).length;
            const level1Count = incidentLogs.filter(log => log.type.includes('Level 1')).length;
            const today = new Date().toDateString();
            const todayCount = incidentLogs.filter(log => new Date(log.timestamp).toDateString() === today).length;

            document.getElementById('level2Count').textContent = level2Count;
            document.getElementById('level1Count').textContent = level1Count;
            document.getElementById('todayIncidentsCount').textContent = todayCount;
            document.getElementById('totalLogsCount').textContent = incidentLogs.length;
        }

        function editLog(id) {
            document.getElementById(`note-${id}`).style.display = 'none';
            document.getElementById(`edit-${id}`).style.display = 'block';
            document.getElementById(`editBtn-${id}`).style.display = 'none';
            document.getElementById(`saveBtn-${id}`).style.display = 'inline-block';
        }

        function saveLog(id) {
            const newNote = document.getElementById(`edit-${id}`).value;
            const log = incidentLogs.find(l => l.id === id);
            if (log) {
                log.notes = newNote;
                localStorage.setItem('drowningLogs', JSON.stringify(incidentLogs));
                updateLogsDisplay();
                showAlert('✅ Note saved!', 'success');
            }
        }

        function deleteLog(id) {
            if (confirm('⚠️ Delete this log entry? This cannot be undone.')) {
                const originalLength = incidentLogs.length;
                incidentLogs = incidentLogs.filter(log => log.id !== id);
                
                if (incidentLogs.length < originalLength) {
                    localStorage.setItem('drowningLogs', JSON.stringify(incidentLogs));
                    updateLogsDisplay();
                    showAlert('🗑️ Log deleted successfully', 'success');
                    console.log(`✅ Deleted log #${id}`);
                } else {
                    showAlert('❌ Failed to delete log', 'error');
                    console.error(`❌ Failed to find log #${id}`);
                }
            }
        }

        function filterLogs(filter, event) {
            currentFilter = filter;
            document.querySelectorAll('.filter-button').forEach(btn => btn.classList.remove('active-filter'));
            if (event && event.target) {
                event.target.classList.add('active-filter');
            }
            updateLogsDisplay();
        }

        function clearAllLogs() {
            if (confirm('⚠️ Delete ALL logs? This cannot be undone!')) {
                incidentLogs = [];
                logIdCounter = 1;
                localStorage.setItem('drowningLogs', JSON.stringify(incidentLogs));
                localStorage.setItem('logIdCounter', '1');
                updateLogsDisplay();
                showAlert('🗑️ All logs cleared', 'success');
            }
        }

        function exportLogs() {
            if (incidentLogs.length === 0) {
                showAlert('⚠️ No logs to export', 'error');
                return;
            }
            let csv = 'ID,Timestamp,Alert Level,Confidence,Notes\n';
            incidentLogs.forEach(log => {
                csv += `${log.id},"${log.timestamp}","${log.type}",${log.confidence},"${log.notes}"\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pool-alert-logs-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            showAlert('💾 Logs exported!', 'success');
        }

        function refreshLogs() {
            incidentLogs = JSON.parse(localStorage.getItem('drowningLogs')) || [];
            updateLogsDisplay();
        }

        // Detection functions
        function showAlert(message, type = 'success') {
            const alertBox = document.getElementById('alertBox');
            alertBox.innerHTML = `<div class="alert ${type}">${message}</div>`;
            setTimeout(() => alertBox.innerHTML = '', 5000);
        }

        async function startWebcam() {
            try {
                const response = await fetch('/start_webcam', { method: 'POST' });
                const data = await response.json();
                if (data.status === 'success') {
                    document.getElementById('videoContainer').innerHTML = '<img id="videoFeed" src="/video_feed">';
                    document.getElementById('statusIndicator').className = 'status-indicator active';
                    showAlert('✅ Webcam started!', 'success');
                    
                    // Start automatic detection polling
                    startDetectionPolling();
                }
            } catch (error) {
                showAlert('❌ Error: ' + error.message, 'error');
            }
        }

        async function stopDetection() {
            try {
                const response = await fetch('/stop_detection', { method: 'POST' });
                const data = await response.json();
                if (data.status === 'success') {
                    document.getElementById('videoContainer').innerHTML = `
                        <div class="video-placeholder">
                            <svg fill="currentColor" viewBox="0 0 20 20">
                                <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"></path>
                            </svg>
                            <p>No video source active</p>
                        </div>
                    `;
                    document.getElementById('statusIndicator').className = 'status-indicator inactive';
                    showAlert('⏹️ Detection stopped', 'success');
                    
                    // Stop automatic detection polling
                    stopDetectionPolling();
                }
            } catch (error) {
                showAlert('❌ Error: ' + error.message, 'error');
            }
        }

        async function uploadVideo(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const formData = new FormData();
                formData.append('video', file);
                showAlert('⏳ Uploading...', 'warning');
                try {
                    const response = await fetch('/upload_video', { method: 'POST', body: formData });
                    const data = await response.json();
                    if (data.status === 'success') {
                        document.getElementById('videoContainer').innerHTML = '<img id="videoFeed" src="/video_feed">';
                        document.getElementById('statusIndicator').className = 'status-indicator active';
                        showAlert('✅ Video uploaded!', 'success');
                        
                        // Start automatic detection polling
                        startDetectionPolling();
                    }
                } catch (error) {
                    showAlert('❌ Error: ' + error.message, 'error');
                }
            }
        }

        async function updateConfidence(value) {
            document.getElementById('confidenceValue').textContent = value + '%';
            try {
                await fetch('/set_confidence', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ confidence: value })
                });
            } catch (error) {}
        }

        // Automatic detection polling and logging
        let detectionPollingInterval = null;
        let alertAudio = null;
        
        // Initialize alert sound
        function initAlertSound() {
            if (!alertAudio) {
                alertAudio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIFmm98OScTgwOUKzn77llHAU7k9nyz3ksBC15yO/ekEALFF2z6OqnVRULRp/g8r5tIQYsg83y2Ik2CBZpvfDknE4MDlCs5++5ZRwFO5PZ8s95LAQtecjv3pBACxRds+jqp1UVCkaf4PK+bSEGLIPN8tiJNggWab3w5JxODA5QrOfvuWUcBTuT2fLPeSwELXnI796QQAsUXbPo6qdVFQpGn+DyvmwhBiyDzfLYiTYIFmm98OScTgwOUKzn77llHAU7k9nyz3ksBC15yO/ekEALFF2z6OqnVRUKRp/g8r5tIQYsg83y2Ik2CBZpvfDknE4MDlCs5++5ZRwFO5PZ8s95LAQtecjv3pBACxRds+jqp1UVCkaf4PK+bSEGLIPN8tiJNggWab3w5JxODA5QrOfvuWUcBTuT2fLPeSwELXnI796QQAsUXbPo6qdVFQpGn+DyvmwhBiyDzfLYiTYIFmm98OScTgwOUKzn77llHAU7k9nyz3ksBC15yO/ekEALFF2z6OqnVRUKRp/g8r5tIQYsg83y2Ik2CBZpvfDknE4MDlCs5++5ZRwFO5PZ8s95LAQtecjv3pBACxRds+jqp1UVCkaf4PK+bSEGLIPN8tiJNggWab3w5JxODA5QrOfvuWUcBTuT2fLPeSwELXnI796QQAsUXbPo6qdVFQpGn+DyvmwhBiyDzfLYiTYIFmm98OScTgwOUKzn77llHAU7k9nyz3ksBC15yO/ekEALFF2z6OqnVRUKRp/g8r5tIQYsg83y2Ik2CBZpvfDknE4MDlCs5++5ZRwFO5PZ8s95LAQtecjv3pBACxRds+jqp1UVCkaf4PK+bSEGLIPN8tiJNggWab3w5JxODA5QrOfvuWUcBTuT2fLPeSwELXnI796QQAsUXbPo6qdVFQpGn+DyvmwhBiyDzfLYiTYIFmm98OScTgwOUKzn77llHAU7k9nyz3ksBC15yO/ekEALFF2z6OqnVRUKRp/g');
            }
        }
        
        function playAlertSound() {
            try {
                initAlertSound();
                if (alertAudio) {
                    alertAudio.play().catch(err => console.log('Audio play failed:', err));
                }
            } catch (error) {
                console.log('Alert sound error:', error);
            }
        }
        
        async function checkForDetections() {
            try {
                const response = await fetch('/get_detections');
                const data = await response.json();
                
                console.log('Detection check:', data); // Debug logging
                
                if (data.status === 'success' && data.detections && data.detections.length > 0) {
                    console.log('Found detections:', data.detections.length); // Debug
                    
                    data.detections.forEach(detection => {
                        console.log('Processing detection:', detection); // Debug
                        
                        // Automatically log detection
                        addLog(detection.type, detection.confidence);
                        
                        // Determine alert type and response based on level
                        const isLevel2 = detection.level === 2;
                        const alertType = isLevel2 ? 'error' : 'warning';
                        const emoji = isLevel2 ? '🚨' : '⚠️';
                        const title = isLevel2 ? 'LEVEL 2 EMERGENCY' : 'LEVEL 1 WARNING';
                        const message = isLevel2 
                            ? `Drowning emergency detected! Confidence: ${detection.confidence}%. Contact medical authorities immediately!`
                            : `Unsafe movement detected! Confidence: ${detection.confidence}%. Staff intervention recommended.`;
                        
                        // Show prominent alert
                        showAlert(`${emoji} ${message}`, alertType);
                        
                        // Play alert sound (louder/more urgent for Level 2)
                        playAlertSound();
                        
                        // Browser notification (if permitted)
                        if ('Notification' in window && Notification.permission === 'granted') {
                            new Notification(`${emoji} ${title}`, {
                                body: message,
                                icon: emoji,
                                requireInteraction: isLevel2, // Only force interaction for Level 2
                                tag: isLevel2 ? 'emergency' : 'warning'
                            });
                        }
                    });
                }
            } catch (error) {
                console.error('Detection polling error:', error);
            }
        }
        
        // Request notification permission on page load
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
        
        // Start polling when webcam/video starts
        function startDetectionPolling() {
            if (!detectionPollingInterval) {
                detectionPollingInterval = setInterval(checkForDetections, 1000); // Check every second
                console.log('✅ Automatic detection logging started');
            }
        }
        
        // Stop polling when detection stops
        function stopDetectionPolling() {
            if (detectionPollingInterval) {
                clearInterval(detectionPollingInterval);
                detectionPollingInterval = null;
                console.log('⏹️ Automatic detection logging stopped');
            }
        }
        
        // Test functions - you can call these manually in browser console
        function testLevel1() {
            addLog('Level 1 - Unsafe Movement', 65);
            console.log('✅ Test Level 1 warning added');
        }
        
        function testLevel2() {
            addLog('Level 2 - Drowning Emergency', 85);
            console.log('✅ Test Level 2 emergency added');
        }

        updateLogsDisplay();
    </script>
</body>
</html>
